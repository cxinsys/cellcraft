# FROM continuumio/miniconda3
# FROM ubuntu:20.04
FROM nvidia/cuda:12.1.0-cudnn8-devel-ubuntu20.04

# 기본 패키지 및 Miniconda3 설치
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget \
    bzip2 \
    && apt-get update && apt-get install --reinstall -y ca-certificates \
    && update-ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && wget --no-check-certificate https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh \
    && bash Miniconda3-latest-Linux-x86_64.sh -b -p /opt/conda \
    && rm Miniconda3-latest-Linux-x86_64.sh

ENV PATH /opt/conda/bin:$PATH

WORKDIR /app

COPY environment.yml ./
RUN conda env create -f environment.yml

COPY . .

RUN apt-get update && apt-get install -y git

# Avoid tzdata asking for geographic location
ENV DEBIAN_FRONTEND=noninteractive

# Set up time zone
ENV TZ=Asia/Seoul
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime

# CUDA Toolkit 설치
RUN apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        ca-certificates \
        software-properties-common

ENV PATH /usr/local/cuda/bin:$PATH
ENV LD_LIBRARY_PATH $LD_LIBRARY_PATH:/usr/local/cuda-12.1/compat

# RUN conda install -n snakemake -c conda-forge cupy
RUN /opt/conda/envs/snakemake/bin/pip install cupy-cuda12x

# Jax 설치
RUN /opt/conda/envs/snakemake/bin/pip install --upgrade pip && \
    /opt/conda/envs/snakemake/bin/pip install "jax[cuda11_cudnn86]" -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

RUN git config --global user.email "chxhyxn@gmail.com"
RUN git config --global user.name "chxhyxn"

ARG GITHUB_TOKEN

# Mate 설치
RUN if [ ! -d "mate" ]; then git clone https://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@github.com/cxinsys/mate.git; fi
RUN cd mate && \
    /opt/conda/envs/snakemake/bin/pip install -e .
    # python setup.py install

# FastTENET 설치
RUN if [ ! -d "fasttenet" ]; then git clone https://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@github.com/cxinsys/fasttenet.git; fi
RUN cd fasttenet && \
    /opt/conda/envs/snakemake/bin/pip install -e .
    # python setup.py install

# Activate the conda environment and run FastAPI
CMD ["/opt/conda/envs/snakemake/bin/python", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0"]

# Create a non-root user
# RUN adduser --disabled-password --gecos '' celeryuser
